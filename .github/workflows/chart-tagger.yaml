name: Helm Chart Tagger

on:
    repository_dispatch:
        types: [helm_chart_image_tag_update]
    workflow_dispatch:
        inputs:
            release_tag:
                description: Image tag to update values.yaml file
                type: string
                required: true
            chr:
                description: Service Now change request number
                type: string
                required: true
            release_note:
                description: 'Confluence link to release notes'
                type: string
                required: true
                
permissions:
  contents: write
  pull-requests: write

jobs:
    update-helm-chart:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6
              with:
                persist-credentials: false

            - name: Update image tag
              run: |
                sed -i -E "/image/{n;s~(tag: ).*~\1${{github.event.client_payload.release_tag}}~}" values.yaml
                git diff
            
            - name: Clean git auth headers
              run: |
                git config --global --remove-section http.https://github.com || true
                git config --global --unset-all http.https://github.com/.extraheader || true

            - name: Create Pull Request
              id: cpr
              uses: peter-evans/create-pull-request@v6
              with:
                  delete-branch: true
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: Prod deployment for release version ${{ github.event.client_payload.release_tag }}
                  title: 'üè∑Ô∏è PROD RELEASE: Bump image version to ${{ github.event.client_payload.release_tag }}'
                  author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
                  branch: 'auto-pr-branch-${{ github.event.client_payload.release_tag }}'
                  base: main
                  body: |
                       AUTO GENERATED PR:
                        Service Now Change Request Number: ${{ github.event.client_payload.chr }}
                        Release Version: ${{ github.event.client_payload.release_tag }} 
                        Release Note: ${{ github.event.client_payload.release_note }}
                  labels: |
                    automated pr

    port-logs:
        if: success() || failure()
        needs: [ update-helm-chart ]
        uses: vkirankumar/portal-glow-mock/.github/workflows/post-logs-to-elastic.yaml
        with:
            release_tag: ${{ needs.generate-release-tag.outputs.release_tag}}
        secrets:
            ELASTIC_HOST: ${{ secrets.ELASTIC_HOST }}
            ELASTIC_KEY: ${{ secrets.ELASTIC_KEY }}

    notify-job-status:
        if: success() || failure()
        uses: vkirankumar/portal-glow-mock/.github/workflows/notify-events.yaml
        needs: [ update-helm-chart ]
        with:
            release_tag: ${{ needs.generate-release-tag.outputs.release_tag}}
            notfication_summary: "[PR-HELM] React Portals <b>PROD</b> deployment"
        secrets:
            TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}
