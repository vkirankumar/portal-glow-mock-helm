name: On PR Merge

on:
    workflow_dispatch:
    # pull_request:
    #   types: 
    #     [closed]

jobs:
    read-release-tag:
        # if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        outputs:
          release_tag: ${{ steps.vars.outputs.release_tag }}
        steps:
            - uses: actions/checkout@v6
              with:
                persist-credentials: false

            - name: Get image tag
              id: vars
              run: |
                IMAGE_TAG=$(sed -n '/^image:/,/^[^ ]/ s/^[[:space:]]*tag:[[:space:]]*//p' values.yaml)
                echo "release_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

    port-logs:
        if: success() || failure()
        needs: [ read-release-tag ]
        uses: vkirankumar/portal-glow-mock/.github/workflows/post-logs-to-elastic.yaml@main
        with:
            release_tag: ${{ needs.read-release-tag.outputs.release_tag }}
        secrets:
            ELASTIC_HOST: ${{ secrets.ELASTIC_HOST }}
            ELASTIC_KEY: ${{ secrets.ELASTIC_KEY }}

    notify-job-status:
        if: success() || failure()
        uses: vkirankumar/portal-glow-mock/.github/workflows/notify-events.yaml@main
        needs: [ read-release-tag, port-logs ]
        with:
            release_tag: ${{ needs.read-release-tag.outputs.release_tag }}
            notfication_summary: "[MERGE-HELM-PR] React Portals <b>PROD</b> deployment"
        secrets:
            TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}
